name: Promote Task-Manager to Production

on:
  push:
    branches:
      - main

permissions:
  contents: write
  id-token: write

env:
  APP_NAME: task-manager
  GITOPS_REPO: jesuslabtech/task-manager-gitops

jobs:
  promote-prod:
    name: Promote Dev Image to Prod
    runs-on: ubuntu-24.04
    environment:
      name: prod
      # GitHub will require manual approval from reviewers before executing this job
    steps:
      # ------------------------------
      # 1️⃣ Checkout GitOps repository
      # ------------------------------
      - name: Checkout GitOps repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITOPS_REPO }}
          token: ${{ secrets.GITOPS_APP_TOKEN }}
          ref: main
          path: gitops # Checkout into subfolder to avoid conflicts with app repo

      # ------------------------------
      # 2️⃣ Configure Git identity for commit
      # ------------------------------
      - name: Configure Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@users.noreply.github.com"

      # ------------------------------
      # 3️⃣ Read SHA of the validated image from DEV overlay
      # ------------------------------
      - name: Retrieve SHA from DEV overlay
        id: get-sha
        run: |
          DEV_OVERLAY_PATH="gitops/apps/task-manager/overlays/dev/kustomization.yaml"
          SHA=$(yq e '.images[0].newTag' $DEV_OVERLAY_PATH)
          echo "image_sha=$SHA" >> $GITHUB_OUTPUT
          echo "✅ Dev overlay SHA: $SHA"

      # ------------------------------
      # 4️⃣ Update PROD overlay with the same SHA
      # ------------------------------
      - name: Update PROD overlay with SHA
        run: |
          PROD_OVERLAY_PATH="gitops/apps/task-manager/overlays/prod/kustomization.yaml"
          SHA=${{ steps.get-sha.outputs.image_sha }}
          echo "Updating PROD overlay newTag to SHA: $SHA"
          yq -i ".images[0].newTag = \"${SHA}\"" $PROD_OVERLAY_PATH

      # ------------------------------
      # 5️⃣ Commit changes if any
      # ------------------------------
      - name: Commit changes
        run: |
          cd gitops
          git add apps/task-manager/overlays/prod/kustomization.yaml
          git diff --cached --quiet || git commit -m "chore(prod): promote task-manager ${{ steps.get-sha.outputs.image_sha }}"

      # ------------------------------
      # 6️⃣ Push changes to GitOps repository
      # ------------------------------
      - name: Push changes
        run: |
          cd gitops
          git push origin main
