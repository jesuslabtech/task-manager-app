name: E2E Tests

# This workflow is triggered when ci.yml finishes
on:
  workflow_run:
    workflows: ['CI Pipeline']
    types:
      - completed

jobs:
  e2e:
    name: Run E2E Tests against Dev
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2️⃣ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.20.0
          cache: 'npm'

      # 3️⃣ Install dependencies
      - name: Install dependencies
        run: |
          npm ci
          npx playwright install --with-deps

      # 4️⃣ Wait for dev environment to be healthy
      - name: Wait for dev environment
        id: wait_dev
        run: |
          URL="${{ secrets.DEV_BASE_URL }}/health"
          echo "Polling $URL"
          for i in {1..20}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" $URL || echo "000")
            echo "Attempt $i: $STATUS"
            if [ "$STATUS" -eq 200 ]; then
              echo "Environment ready!"
              exit 0
            fi
            sleep 15
          done
          echo "Environment not ready after 5 minutes."
          exit 1

      # 5️⃣ Run Playwright tests
      - name: Run E2E Tests
        run: |
          BASE_URL=${{ secrets.DEV_BASE_URL }} npx playwright test --reporter=list,html

      # 6️⃣ Generate dynamic filenames for Playwright report
      - name: Generate dynamic filenames for Playwright report
        id: filenames
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          echo "playwright-report-folder=playwright-report-$TIMESTAMP" >> $GITHUB_OUTPUT

      # 7️⃣ Upload HTML report as artifact
      - name: Upload E2E Report
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.filenames.outputs.playwright-report-folder }}
          path: playwright-report/
