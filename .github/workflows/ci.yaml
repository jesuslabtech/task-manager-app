name: CI Pipeline

on:
  push:
    branches:
      - develop

env:
  APP_NAME: task-manager
  DOCKERHUB_REPO: jlabtech/task-manager
  DOCKER_IMAGE_SHA_TAG: sha-${{ github.sha }} # SHA como tag inmutable
  DOCKER_IMAGE_VERSION_TAG: ${{ github.sha }} # Se reemplaza con semver en el push

jobs:
  # ------------------------------
  # 1️⃣ Validation Job
  # ------------------------------
  validation:
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22.20.0
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: ESLint
        run: npm run lint

      - name: Prettier check
        run: npm run format:check

      - name: Run Jest tests
        run: npm run test:coverage

      - name: Trivy FS scan (SARIF)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          scanners: 'vuln,secret'
          cache: true
          exit-code: 1

      - name: Trivy FS scan (console)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          skip-setup-trivy: true
          exit-code: 1

      - name: Upload Trivy SARIF to GitHub
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results.sarif'

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602
        with:
          fetch-depth: 0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ------------------------------
  # 2️⃣ Build, Scan & Push Docker Image
  # ------------------------------
  build-scan-push:
    runs-on: ubuntu-24.04
    needs: validation
    timeout-minutes: 20
    permissions:
      contents: read
      security-events: write
      actions: read
    outputs:
      image_sha_tag: ${{ steps.push-image.outputs.sha_tag }}
      image_version_tag: ${{ steps.push-image.outputs.version_tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read version from RELEASE.md
        id: get_version
        run: |
          VERSION=$(cat RELEASE.md | tr -d ' \n')
          echo "version_tag=$VERSION" >> $GITHUB_OUTPUT

      - name: Build Docker image
        run: |
          docker build \
            --no-cache \
            -t $DOCKERHUB_REPO:${{ env.DOCKER_IMAGE_SHA_TAG }} \
            -t $DOCKERHUB_REPO:${{ steps.get_version.outputs.version_tag }} .

      - name: Generate dynamic filenames for Trivy scan
        id: filenames
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          echo "scan_file=trivy-scan-$TIMESTAMP.json" >> $GITHUB_OUTPUT
          echo "sbom_file=trivy-sbom-$TIMESTAMP.json" >> $GITHUB_OUTPUT

      - name: Scan Docker image locally (JSON)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          image-ref: ${{ env.DOCKERHUB_REPO }}:${{ env.DOCKER_IMAGE_SHA_TAG }}
          format: json
          severity: CRITICAL
          scanners: vuln
          vuln-type: library
          ignore-unfixed: true
          output: ${{ steps.filenames.outputs.scan_file }}
          cache: false

      - name: Generate SBOM (SPDX JSON)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          image-ref: ${{ env.DOCKERHUB_REPO }}:${{ env.DOCKER_IMAGE_SHA_TAG }}
          format: spdx-json
          output: ${{ steps.filenames.outputs.sbom_file }}
          cache: false

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.filenames.outputs.scan_file }}
          path: ${{ steps.filenames.outputs.scan_file }}

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.filenames.outputs.sbom_file }}
          path: ${{ steps.filenames.outputs.sbom_file }}

      - name: Fail if CRITICAL vulnerabilities are found
        run: |
          FILE=${{ steps.filenames.outputs.scan_file }}
          COUNT=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "$FILE")
          if [ "$COUNT" -gt 0 ]; then
            echo "❌ Found $COUNT CRITICAL vulnerabilities!"
            exit 1
          else
            echo "✅ No CRITICAL vulnerabilities found."
          fi
        shell: bash

      - name: DockerHub Login
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push Docker image
        id: push-image
        run: |
          # Push SHA tag (immutable, for promotion)
          docker push $DOCKERHUB_REPO:${{ env.DOCKER_IMAGE_SHA_TAG }}
          # Push semantic version tag
          docker tag $DOCKERHUB_REPO:${{ env.DOCKER_IMAGE_SHA_TAG }} $DOCKERHUB_REPO:${{ steps.get_version.outputs.version_tag }}
          docker push $DOCKERHUB_REPO:${{ steps.get_version.outputs.version_tag }}
          # Output only the SHA for newTag
          echo "sha_tag=${{ env.DOCKER_IMAGE_SHA_TAG }}" >> $GITHUB_OUTPUT
          echo "version_tag=${{ steps.get_version.outputs.version_tag }}" >> $GITHUB_OUTPUT

  # ------------------------------
  # 3️⃣ Update GitOps Overlay Dev
  # ------------------------------
  update-gitops-dev:
    permissions:
      contents: write
    runs-on: ubuntu-24.04
    needs: build-scan-push
    timeout-minutes: 10
    steps:
      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: jesuslabtech/task-manager-gitops
          token: ${{ secrets.GITOPS_TOKEN }}
          path: gitops

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions@users.noreply.github.com"

      - name: Update DEV overlay with SHA
        run: |
          cd gitops/apps/task-manager/overlays/dev
          NEW_SHA=${{ needs.build-scan-push.outputs.image_sha_tag }}
          echo "Updating newTag to SHA: $NEW_SHA"
          sed -i "s|newTag: .*|newTag: ${NEW_SHA}|" kustomization.yaml
          cat kustomization.yaml

      - name: Commit changes if any
        run: |
          cd gitops
          git add apps/task-manager/overlays/dev/kustomization.yaml
          git diff --cached --quiet || git commit -m "chore(dev): update task-manager image to SHA ${{ needs.build-scan-push.outputs.image_sha_tag }}"

      - name: Push changes
        run: |
          cd gitops
          git push origin main
